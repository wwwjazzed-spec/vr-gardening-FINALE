<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>VR Gardening Game</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>
  <!-- Three.js core -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.148.0/build/three.min.js"></script>
  <!-- Controls -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.148.0/examples/js/controls/DeviceOrientationControls.js"></script>
  <!-- WebXR VR Button -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.148.0/examples/js/webxr/VRButton.js"></script>

<script>
let scene, camera, renderer, controls;
let soils = [], plants = [];

init();
animate();

function init(){
  scene = new THREE.Scene();

  // Camera
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0,1.6,3);

  // Renderer
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;  // enable WebXR
  document.body.appendChild(renderer.domElement);
  document.body.appendChild(VRButton.createButton(renderer));

  // Device orientation (look around with head)
  controls = new THREE.DeviceOrientationControls(camera);

  // Light
  let light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(1,1,1).normalize();
  scene.add(light);

  // Ground
  let ground = new THREE.Mesh(
    new THREE.PlaneGeometry(20,20),
    new THREE.MeshPhongMaterial({color:0x228B22})
  );
  ground.rotation.x = -Math.PI/2;
  scene.add(ground);

  // Soil patches
  let soilMat = new THREE.MeshPhongMaterial({color:0x8B4513});
  for(let x=-2;x<=2;x+=2){
    for(let z=-2;z<=2;z+=2){
      let soil = new THREE.Mesh(
        new THREE.BoxGeometry(1,0.2,1),
        soilMat
      );
      soil.position.set(x,0.1,z);
      scene.add(soil);
      soils.push(soil);
    }
  }

  window.addEventListener('resize', onWindowResize);
}

function onWindowResize(){
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

// Plant a cone (tree)
function spawnPlant(position){
  let plant = new THREE.Mesh(
    new THREE.ConeGeometry(0.2,0.5,8),
    new THREE.MeshPhongMaterial({color:0x00ff00})
  );
  plant.position.copy(position);
  plant.position.y += 0.25;
  scene.add(plant);
  plants.push(plant);
}

// Watering = grow nearby plants
function waterPlants(ray){
  let hits = ray.intersectObjects(plants);
  for(let h of hits){
    h.object.scale.multiplyScalar(1.05);
  }
}

// --- GAMEPAD HANDLING ---
function handleGamepad(){
  let gp = navigator.getGamepads()[0];
  if(!gp) return;

  let ray = new THREE.Raycaster();
  ray.setFromCamera(new THREE.Vector2(0,0), camera);

  // X = Plant
  if(gp.buttons[0].pressed){
    let hits = ray.intersectObjects(soils);
    if(hits.length>0) spawnPlant(hits[0].point);
  }

  // O = Water
  if(gp.buttons[1].pressed){
    waterPlants(ray);
  }

  // Square = Remove plant under reticle
  if(gp.buttons[2].pressed){
    let hits = ray.intersectObjects(plants);
    if(hits.length>0){
      scene.remove(hits[0].object);
      plants.splice(plants.indexOf(hits[0].object),1);
    }
  }

  // Triangle = Reset all plants
  if(gp.buttons[3].pressed){
    for(let p of plants) scene.remove(p);
    plants.length = 0;
  }

  // D-Pad Movement
  if(gp.buttons[12].pressed) camera.position.z -= 0.05; // up
  if(gp.buttons[13].pressed) camera.position.z += 0.05; // down
  if(gp.buttons[14].pressed) camera.position.x -= 0.05; // left
  if(gp.buttons[15].pressed) camera.position.x += 0.05; // right

  // Rotate with L1 / R1
  if(gp.buttons[4].pressed) camera.rotation.y += 0.03;
  if(gp.buttons[5].pressed) camera.rotation.y -= 0.03;
}

function animate(){
  renderer.setAnimationLoop(()=>{
    controls.update();
    handleGamepad();
    renderer.render(scene, camera);
  });
}
</script>
</body>
</html>